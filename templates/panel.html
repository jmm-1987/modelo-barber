<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Panel de Control - Citas Peluquer√≠a</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
      overflow-x: hidden;
    }
    .panel-container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
      border-radius: 20px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
      padding: 40px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    h1 { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center; 
      margin-bottom: 40px;
      font-size: 32px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .calendario-semanal {
      display: grid;
      grid-template-columns: 100px repeat(7, 1fr);
      gap: 8px;
      margin-top: 30px;
      padding: 20px;
      background: linear-gradient(145deg, #f8f9ff 0%, #ffffff 100%);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
    }
    
    .calendario-diario {
      display: none;
      margin-top: 20px;
    }
    
    .dia-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 20px;
      text-align: center;
      border-radius: 16px 16px 0 0;
      font-size: 20px;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .dia-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }
    
    .horas-lista {
      background: white;
      border-radius: 0 0 10px 10px;
      overflow: hidden;
    }
    
    .hora-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
      margin: 2px 0;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.08);
    }
    
    .hora-item:last-child {
      border-bottom: none;
    }
    
    .hora-item.libre {
      background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 2px solid #0ea5e9;
    }
    
    .hora-item.ocupada {
      background: linear-gradient(145deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .hora-item.ocupada::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }
    
    .hora-item.cerrado {
      background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #64748b;
      opacity: 0.7;
    }
    
    .hora-texto {
      font-weight: 700;
      font-size: 18px;
      color: #1e293b;
    }
    
    .cita-detalle {
      text-align: right;
      font-size: 14px;
    }
    
    .cita-nombre-mobile {
      font-weight: 700;
      color: #0f766e;
      display: block;
      font-size: 16px;
    }
    
    .cita-servicio-mobile {
      color: #64748b;
      font-size: 14px;
      font-weight: 500;
    }
    
    .dia-selector {
      display: none;
      margin-bottom: 20px;
    }
    
    .dia-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      margin: 0 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .dia-btn:hover {
      background: #1976d2;
    }
    
    .dia-btn.activo {
      background: #1565c0;
    }
    .header-dia {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 12px;
      text-align: center;
      font-weight: 700;
      border-radius: 16px 16px 0 0;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }
    .header-dia::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }
    .header-hora {
      background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #475569;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
      border-radius: 12px;
      margin: 2px;
      box-shadow: 0 2px 6px rgba(71, 85, 105, 0.1);
    }
    .celda-hora {
      background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
      border: none;
      padding: 12px 8px;
      text-align: center;
      font-size: 13px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
      border-radius: 12px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);
      margin: 2px;
    }
    .celda-hora.libre {
      background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #0369a1;
      transition: all 0.3s ease;
      border: 2px solid #0ea5e9;
    }
    .celda-hora.libre:hover {
      background: linear-gradient(145deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
    }
    
    .celda-hora.hoy {
      background: #e8f5e8;
      border: 2px solid #4caf50;
      font-weight: bold;
    }
    .celda-hora.ocupada {
      background: linear-gradient(145deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 2px solid #f59e0b;
      position: relative;
      overflow: hidden;
    }
    .celda-hora.ocupada::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }
    .celda-hora.ocupada:hover {
      background: linear-gradient(145deg, #f59e0b 0%, #d97706 100%);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(245, 158, 11, 0.4);
      z-index: 10;
    }
    
    .celda-hora.ocupada.hoy {
      border: 2px solid #4caf50;
    }
    .cita-info {
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 11px;
      line-height: 1.3;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 5;
      transform-origin: center center;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    .cita-info:hover {
      transform: scale(1.15);
      z-index: 9999;
      background: linear-gradient(145deg, #ffffff 0%, #f0f9ff 100%);
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      font-size: 13px;
      padding: 8px 10px;
      border: 2px solid #0ea5e9;
    }
    .cita-nombre {
      font-weight: 700;
      color: #0f766e;
      font-size: 12px;
    }
    .cita-servicio {
      color: #64748b;
      font-size: 10px;
      font-weight: 500;
    }
    .cita-info:hover .cita-servicio {
      font-size: 10px;
    }
    .controles {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    .btn-nav {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .btn-nav:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .semana-actual {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      min-width: 200px;
      text-align: center;
    }
    .resumen {
      background: linear-gradient(145deg, #f8f9ff 0%, #e8eaff 100%);
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
      border: 1px solid #e8eaff;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.1);
    }
    .resumen h3 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-top: 0;
      font-weight: 700;
      font-size: 20px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat {
      background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
      border: 1px solid #e8eaff;
      transition: all 0.3s ease;
    }
    .stat:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }
    .stat-numero {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    
    /* Responsive para m√≥vil */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .panel-container {
        margin: 0;
        padding: 20px 15px;
        border-radius: 15px;
        max-width: 100%;
      }
      
      h1 {
        font-size: 32px;
        margin-bottom: 30px;
      }
      
      .calendario-semanal {
        display: none;
      }
      
      .calendario-diario {
        display: block;
      }
      
      .dia-selector {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 18px;
        margin-bottom: 30px;
      }
      
      .dia-btn {
        padding: 15px 20px;
        font-size: 16px;
        margin: 0 3px;
        border-radius: 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        min-width: 80px;
        min-height: 50px;
      }
      
      .dia-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      
      .dia-btn.activo {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      }
      
      .dia-btn.hoy {
        border: 2px solid #10b981;
        position: relative;
      }
      
      .dia-btn.hoy::after {
        content: '‚óè';
        position: absolute;
        top: -8px;
        right: -8px;
        color: #10b981;
        font-size: 16px;
        background: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      
      .controles {
        flex-direction: column;
        gap: 25px;
        margin-bottom: 35px;
      }
      
      .btn-nav {
        padding: 15px 25px;
        font-size: 16px;
        border-radius: 30px;
        min-height: 50px;
        min-width: 120px;
      }
      
      .semana-actual {
        font-size: 20px;
        min-width: auto;
        padding: 15px 25px;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 30px;
      }
      
      .stat {
        padding: 25px;
        border-radius: 20px;
      }
      
      .stat-numero {
        font-size: 28px;
      }
      
      .stat-label {
        font-size: 16px;
      }
      
      .dia-header {
        padding: 35px 30px;
        font-size: 24px;
        border-radius: 25px 25px 0 0;
      }
      
      .horas-lista {
        border-radius: 0 0 20px 20px;
      }
      
      .hora-item {
        padding: 15px 20px;
        margin: 4px 0;
        border-radius: 12px;
        min-height: 60px;
      }
      
      .hora-texto {
        font-size: 18px;
      }
      
      .cita-detalle {
        font-size: 16px;
      }
      
      .cita-nombre-mobile {
        font-size: 24px;
        font-weight: 700;
        color: #0f766e;
        margin-right: 20px;
        flex: 1;
      }
      
      .cita-servicio-mobile {
        font-size: 20px;
        font-weight: 600;
        color: #475569;
        margin-top: 10px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        padding: 8px 16px;
        border-radius: 25px;
        border: 1px solid #cbd5e1;
        display: inline-block;
        box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      }
      
      /* Opciones m√≥viles para citas */
      .opciones-mobile {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-left: auto;
      }
      
      .opcion-mobile {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        border: 2px solid transparent;
        min-width: 40px;
        min-height: 40px;
      }
      
      .opcion-mobile svg {
        width: 18px;
        height: 18px;
      }
      
      .opcion-whatsapp {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
      }
      
      .opcion-whatsapp:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(37, 211, 102, 0.4);
        border-color: #25d366;
      }
      
      .opcion-llamar {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
      }
      
      .opcion-llamar:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        border-color: #3b82f6;
      }
      
      .opcion-eliminar {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }
      
      .opcion-eliminar:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        border-color: #ef4444;
      }
    }
    
    /* Responsive para pantallas muy peque√±as */
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      
      .panel-container {
        padding: 15px 10px;
        margin: 0;
        border-radius: 10px;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      .dia-btn {
        padding: 12px 16px;
        font-size: 14px;
        min-width: 70px;
        min-height: 45px;
      }
      
      .btn-nav {
        padding: 12px 20px;
        font-size: 14px;
        min-width: 100px;
        min-height: 45px;
      }
      
      .hora-item {
        padding: 12px 15px;
        min-height: 55px;
      }
      
      .hora-texto {
        font-size: 16px;
      }
      
      .cita-detalle {
        font-size: 14px;
      }
      
      .cita-nombre-mobile {
        font-size: 18px;
      }
      
      .cita-servicio-mobile {
        font-size: 16px;
      }
      
      .opcion-mobile {
        width: 35px;
        height: 35px;
        font-size: 14px;
        min-width: 35px;
        min-height: 35px;
      }
      
      .opcion-mobile svg {
        width: 16px;
        height: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="panel-container">
    <h1>üìÖ Panel de Control de Citas</h1>
    
    <div class="controles">
      <button class="btn-nav" onclick="cambiarSemana(-1)">‚Üê 7 D√≠as Anteriores</button>
      <button class="btn-nav" onclick="volverHoy()" style="background: #4caf50;">üìÖ Hoy</button>
      <div class="semana-actual" id="semana-actual"></div>
      <button class="btn-nav" onclick="cambiarSemana(1)">7 D√≠as Siguientes ‚Üí</button>
    </div>

    <div class="calendario-semanal" id="calendario">
      <!-- Se llena din√°micamente -->
    </div>

    <div class="dia-selector" id="dia-selector">
      <!-- Se llena din√°micamente -->
    </div>

    <div class="calendario-diario" id="calendario-diario">
      <div class="dia-header" id="dia-header">
        <!-- Se llena din√°micamente -->
      </div>
      <div class="horas-lista" id="horas-lista">
        <!-- Se llena din√°micamente -->
      </div>
    </div>

    <div class="resumen">
      <h3>üìä Resumen de los 7 D√≠as</h3>
      <div class="stats" id="stats">
        <!-- Se llena din√°micamente -->
      </div>
    </div>

    <!-- Botones de desarrollo para generar citas de prueba -->
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
      <h4 style="color: #6c757d; margin-top: 0;">üõ†Ô∏è Herramientas de Desarrollo</h4>
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <button onclick="generarCitasPrueba()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
          üé≤ Generar Citas de Prueba
        </button>
        <button onclick="limpiarCitas()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
          üóëÔ∏è Limpiar Todas las Citas
        </button>
      </div>
      <div id="mensaje-desarrollo" style="margin-top: 10px; font-size: 14px; color: #6c757d;"></div>
    </div>
  </div>

  <script>
    const HORAS = [
      '10:00', '10:30', '11:00', '11:30',
      '12:00', '12:30', '13:00', '13:30',
      '16:00', '16:30', '17:00', '17:30',
      '18:00', '18:30', '19:00', '19:30'
    ];
    
    let semanaActual = new Date(); // Empezar desde hoy
    let diaActual = new Date();
    
    // Debug: mostrar la semana que se est√° cargando
    console.log('üìÖ Semana actual cargada:', semanaActual.toISOString().split('T')[0]);

    function formatearFecha(fecha) {
      const dia = fecha.getDate().toString().padStart(2, '0');
      const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
      const anio = fecha.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }

    function formatearFechaAPI(fecha) {
      return fecha.toISOString().split('T')[0];
    }

    function obtenerNombreDia(fecha) {
      const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      return dias[fecha.getDay()];
    }

    function obtenerDiaSemana(fecha) {
      const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      return dias[fecha.getDay()];
    }

    function cambiarSemana(direccion) {
      // Cambiar semana: avanzar/retroceder 7 d√≠as desde la fecha actual
      semanaActual.setDate(semanaActual.getDate() + (direccion * 7));
      cargarCalendario();
    }

    function volverHoy() {
      // Volver al d√≠a actual
      semanaActual = new Date();
      diaActual = new Date(); // Tambi√©n actualizar diaActual para m√≥vil
      cargarCalendario();
      
      // Si es m√≥vil, tambi√©n actualizar la vista diaria
      if (esMovil()) {
        console.log('üì± M√≥vil - Bot√≥n Hoy presionado');
        cargarCalendarioDiario();
      }
    }

    function cambiarDia(direccion) {
      diaActual.setDate(diaActual.getDate() + direccion);
      cargarCalendarioDiario();
    }

    function seleccionarDia(fecha) {
      // Convertir fecha DD/MM/YYYY a objeto Date
      const partes = fecha.split('/');
      const dia = parseInt(partes[0]);
      const mes = parseInt(partes[1]) - 1; // Meses van de 0-11
      const anio = parseInt(partes[2]);
      
      diaActual = new Date(anio, mes, dia);
      cargarCalendarioDiario();
    }

    async function cargarCalendario() {
      const calendario = document.getElementById('calendario');
      const semanaActualDiv = document.getElementById('semana-actual');
      
      // Actualizar t√≠tulo de la semana
      const finSemana = new Date(semanaActual);
      finSemana.setDate(finSemana.getDate() + 6);
      semanaActualDiv.textContent = `${formatearFecha(semanaActual)} - ${formatearFecha(finSemana)}`;

      // Crear encabezados de d√≠as (empezando desde hoy)
      let html = '<div class="header-hora">Hora</div>';
      const hoy = new Date();
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaActual);
        dia.setDate(dia.getDate() + i);
        const esHoy = dia.toDateString() === hoy.toDateString();
        const claseHoy = esHoy ? ' style="background:#4caf50; font-weight:bold;"' : '';
        html += `<div class="header-dia"${claseHoy}>${obtenerNombreDia(dia)}<br>${dia.getDate()}</div>`;
      }

      // Crear filas de horas
      for (const hora of HORAS) {
        html += `<div class="header-hora">${hora}</div>`;
        
        for (let i = 0; i < 7; i++) {
          const dia = new Date(semanaActual);
          dia.setDate(dia.getDate() + i);
          const fechaStr = formatearFechaAPI(dia);
          
          // Verificar si es domingo (d√≠a cerrado)
          if (dia.getDay() === 0) {
            html += `<div class="celda-hora" style="background:#d0d0d0; color:#666;">Cerrado</div>`;
          } else {
            const hoy = new Date();
            const esHoy = dia.toDateString() === hoy.toDateString();
            const claseHoy = esHoy ? ' hoy' : '';
            html += `<div class="celda-hora libre${claseHoy}" data-fecha="${fechaStr}" data-hora="${hora}">Libre</div>`;
          }
        }
      }

      calendario.innerHTML = html;

      // Cargar datos de citas para toda la semana
      await cargarCitasSemana();
    }

    async function cargarCitasSemana() {
      const celdas = document.querySelectorAll('.celda-hora[data-fecha]');
      const citasSemana = [];

      // Cargar citas para cada d√≠a de la semana (empezando desde hoy)
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaActual);
        dia.setDate(dia.getDate() + i);
        const fechaStr = formatearFecha(dia);
        const esHoy = dia.toDateString() === new Date().toDateString();
        console.log(`üîç D√≠a ${i}: ${fechaStr} (${obtenerNombreDia(dia)})${esHoy ? ' - HOY' : ''}`);
        
        if (dia.getDay() !== 0) { // No domingo
          try {
            const fechaAPI = formatearFechaAPI(dia);
            console.log(`üîç Consultando citas para: ${fechaAPI} (${fechaStr})`);
            
            const res = await fetch('/citas_dia', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dia: fechaAPI })
            });
            const data = await res.json();
            console.log(`üìÖ Citas encontradas para ${fechaAPI}:`, data.citas);
            citasSemana.push(...data.citas);
            
            // Actualizar celdas con citas
            data.citas.forEach(cita => {
              const celda = document.querySelector(`[data-fecha="${fechaAPI}"][data-hora="${cita.hora}"]`);
              console.log(`üîç Buscando celda: ${fechaAPI} ${cita.hora} - Encontrada: ${celda ? 'S√ç' : 'NO'}`);
              if (celda) {
                const hoy = new Date();
                const diaCita = new Date(fechaAPI);
                const esHoy = diaCita.toDateString() === hoy.toDateString();
                const claseHoy = esHoy ? ' hoy' : '';
                celda.className = `celda-hora ocupada${claseHoy}`;
                celda.innerHTML = `
                  <div class="cita-info" 
                       onclick="mostrarOpcionesCita('${cita.nombre}', '${cita.servicio}', '${fechaAPI}', '${cita.hora}', '${cita.telefono}')"
                       title="${cita.nombre} - ${cita.servicio} - ${cita.telefono}">
                    <div class="cita-nombre">${cita.nombre}</div>
                    <div class="cita-servicio">${cita.servicio}</div>
                  </div>
                `;
              }
            });
          } catch (error) {
            console.error('Error cargando citas:', error);
          }
        }
      }

      // Actualizar estad√≠sticas
      actualizarEstadisticas(citasSemana);
      
      // Cargar vista diaria si es m√≥vil
      if (esMovil()) {
        cargarCalendarioDiario();
      }
    }

    async function cargarCalendarioDiario() {
      const diaHeader = document.getElementById('dia-header');
      const horasLista = document.getElementById('horas-lista');
      const diaSelector = document.getElementById('dia-selector');
      
      // Actualizar header del d√≠a
      const nombreDia = obtenerDiaSemana(diaActual);
      const fechaStr = formatearFecha(diaActual);
      const fechaAPI = formatearFechaAPI(diaActual);
      const esHoy = diaActual.toDateString() === new Date().toDateString();
      
      console.log(`üì± M√≥vil - Cargando d√≠a: ${fechaStr} (${fechaAPI})${esHoy ? ' - HOY' : ''}`);
      
      const headerText = esHoy ? 
        `üìÖ ${nombreDia}, ${diaActual.getDate()} de ${diaActual.toLocaleDateString('es-ES', {month: 'long'})} (Hoy)` :
        `${nombreDia}, ${diaActual.getDate()} de ${diaActual.toLocaleDateString('es-ES', {month: 'long'})}`;
      
      diaHeader.textContent = headerText;
      
      // Crear selector de d√≠as para la semana
      let selectorHtml = '';
      const hoy = new Date();
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaActual);
        dia.setDate(dia.getDate() + i);
        const diaFechaStr = formatearFecha(dia);
        const diaActualStr = formatearFecha(diaActual);
        const esActivo = diaFechaStr === diaActualStr;
        const esDomingo = dia.getDay() === 0;
        const esHoy = dia.toDateString() === hoy.toDateString();
        
        if (!esDomingo) {
          const claseActivo = esActivo ? 'activo' : '';
          const claseHoy = esHoy ? 'hoy' : '';
          selectorHtml += `<button class="dia-btn ${claseActivo} ${claseHoy}" onclick="seleccionarDia('${diaFechaStr}')">${obtenerNombreDia(dia)} ${dia.getDate()}</button>`;
        }
      }
      diaSelector.innerHTML = selectorHtml;
      
      // Crear lista de horas
      let horasHtml = '';
      
      try {
        const fechaConsulta = formatearFechaAPI(diaActual);
        console.log(`üì± M√≥vil - Consultando citas para: ${fechaConsulta}`);
        
        const res = await fetch('/citas_dia', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dia: fechaConsulta })
        });
        const data = await res.json();
        console.log(`üì± M√≥vil - Citas encontradas:`, data.citas);
        
        for (const hora of HORAS) {
          const cita = data.citas.find(c => c.hora === hora);
          let clase = 'hora-item libre';
          let contenido = `<div class="hora-texto">${hora}</div><div class="cita-detalle">Libre</div>`;
          
          if (cita) {
            clase = 'hora-item ocupada';
            contenido = `
              <div class="hora-texto">${hora}</div>
              <div class="cita-detalle">
                <div style="display: flex; align-items: center; width: 100%;">
                  <span class="cita-nombre-mobile">${cita.nombre}</span>
                  <div class="opciones-mobile">
                    <div class="opcion-mobile opcion-whatsapp" onclick="contactarWhatsApp('${cita.telefono}', '${cita.nombre}', '${cita.servicio}', '${formatearFecha(diaActual)}', '${hora}')" title="WhatsApp">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                      </svg>
                    </div>
                    <div class="opcion-mobile opcion-llamar" onclick="llamarCliente('${cita.telefono}', '${cita.nombre}')" title="Llamar">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19c-.55 0-.99.45-.99.99 0 9.36 7.6 16.96 16.96 16.96.54 0 .99-.45.99-.99v-3.45c0-.54-.45-.99-.99-.99z"/>
                      </svg>
                    </div>
                    <div class="opcion-mobile opcion-eliminar" onclick="eliminarCita('${formatearFechaAPI(diaActual)}', '${hora}', '${cita.nombre}')" title="Eliminar">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </div>
                  </div>
                </div>
                <span class="cita-servicio-mobile">${cita.servicio}</span>
              </div>
            `;
          }
          
          horasHtml += `<div class="${clase}">${contenido}</div>`;
        }
      } catch (error) {
        console.error('Error cargando citas del d√≠a:', error);
        // Mostrar horas libres por defecto
        for (const hora of HORAS) {
          horasHtml += `<div class="hora-item libre"><div class="hora-texto">${hora}</div><div class="cita-detalle">Libre</div></div>`;
        }
      }
      
      horasLista.innerHTML = horasHtml;
    }

    function actualizarEstadisticas(citas) {
      const stats = document.getElementById('stats');
      
      const totalCitas = citas.length;
      const citasPorServicio = {};
      
      citas.forEach(cita => {
        // Contar por servicio
        citasPorServicio[cita.servicio] = (citasPorServicio[cita.servicio] || 0) + 1;
      });

      const servicioMasPopular = Object.keys(citasPorServicio).reduce((a, b) => 
        citasPorServicio[a] > citasPorServicio[b] ? a : b, 'N/A');

      stats.innerHTML = `
        <div class="stat">
          <div class="stat-numero">${totalCitas}</div>
          <div class="stat-label">Total Citas</div>
        </div>
        <div class="stat">
          <div class="stat-numero">${servicioMasPopular}</div>
          <div class="stat-label">Servicio M√°s Popular</div>
        </div>
        <div class="stat">
          <div class="stat-numero">${Math.round((totalCitas / 7) * 10) / 10}</div>
          <div class="stat-label">Promedio/D√≠a</div>
        </div>
      `;
    }

    function mostrarOpcionesCita(nombre, servicio, fecha, hora, telefono) {
      // Crear modal con opciones
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      // Convertir fecha de formato API (YYYY-MM-DD) a formato de visualizaci√≥n (DD/MM/YYYY)
      const fechaDisplay = fecha.split('-').reverse().join('/');
      
      const contenido = document.createElement('div');
      contenido.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
      `;
      
      contenido.innerHTML = `
        <h3 style="margin-top: 0; color: #2196f3;">üìÖ Cita de ${nombre}</h3>
        <p><strong>Servicio:</strong> ${servicio}</p>
        <p><strong>Fecha:</strong> ${fechaDisplay}</p>
        <p><strong>Hora:</strong> ${hora}</p>
        <p><strong>Tel√©fono:</strong> ${telefono}</p>
        
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 25px;">
          <div onclick="contactarWhatsApp('${telefono}', '${nombre}', '${servicio}', '${fechaDisplay}', '${hora}')" 
               style="background: #25d366; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
            </svg>
          </div>
          <div onclick="llamarTelefono('${telefono}')" 
               style="background: #2196f3; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19c-.55 0-.99.45-.99.99 0 9.36 7.6 16.96 16.96 16.96.54 0 .99-.45.99-.99v-3.45c0-.54-.45-.99-.99-.99z"/>
            </svg>
          </div>
          <div onclick="borrarCita('${fecha}', '${hora}', '${nombre}')" 
               style="background: #f44336; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
          </div>
        </div>
        
        <div onclick="cerrarModal()" 
             style="background: #666; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; margin: 20px auto 0; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </div>
      `;
      
      // Agregar efectos hover a los iconos
      const iconos = contenido.querySelectorAll('div[onclick]');
      iconos.forEach(icono => {
        icono.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.1)';
          this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
        });
        icono.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
          this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        });
      });
      
      modal.appendChild(contenido);
      document.body.appendChild(modal);
    }

    function cerrarModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }

    function contactarWhatsApp(telefono, nombre, servicio, fecha, hora) {
      const mensaje = `Hola ${nombre}, te contactamos sobre tu cita de ${servicio} el ${fecha} a las ${hora}. ¬øTodo bien?`;
      const url = `https://wa.me/34${telefono}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
      cerrarModal();
    }

    function llamarCliente(telefono, nombre) {
      if (confirm(`¬øQuieres llamar a ${nombre} al ${telefono}?`)) {
        window.open(`tel:${telefono}`, '_blank');
      }
    }

    async function eliminarCita(fecha, hora, nombre) {
      if (confirm(`¬øEst√°s seguro de que quieres eliminar la cita de ${nombre} el ${fecha} a las ${hora}?`)) {
        try {
          const res = await fetch('/borrar_cita', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fecha, hora })
          });
          const data = await res.json();
          if (data.ok) {
            alert('‚úÖ Cita eliminada correctamente');
            // Recargar el calendario
            if (esMovil()) {
              cargarCalendarioDiario();
            } else {
              cargarCitasSemana();
            }
          } else {
            alert('‚ùå Error al eliminar la cita: ' + data.msg);
          }
        } catch (error) {
          alert('‚ùå Error al eliminar la cita: ' + error);
        }
      }
    }

    function llamarTelefono(telefono) {
      window.open(`tel:${telefono}`, '_blank');
      cerrarModal();
    }

    async function borrarCita(fecha, hora, nombre) {
      if (confirm(`¬øEst√°s seguro de que quieres borrar la cita de ${nombre} el ${fecha} a las ${hora}?`)) {
        try {
          const res = await fetch('/borrar_cita', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fecha, hora })
          });
          const data = await res.json();
          if (data.ok) {
            alert('Cita borrada correctamente');
            cargarCitasSemana(); // Recargar el calendario
          } else {
            alert('Error al borrar la cita: ' + data.msg);
          }
        } catch (error) {
          alert('Error al borrar la cita: ' + error);
        }
        cerrarModal();
      }
    }

    // Funci√≥n para detectar si es m√≥vil
    function esMovil() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Cargar calendario al iniciar
    document.addEventListener('DOMContentLoaded', function() {
      cargarCalendario();
      
      // Detectar si es m√≥vil y cargar vista diaria
      if (esMovil()) {
        // En m√≥vil, mostrar solo el d√≠a de hoy por defecto
        diaActual = new Date(); // Asegurar que diaActual sea hoy
        console.log('üì± M√≥vil detectado - Cargando vista diaria para hoy');
        cargarCalendarioDiario();
      }
    });

    // Actualizar cada 30 segundos
    setInterval(function() {
      cargarCitasSemana();
      if (esMovil()) {
        cargarCalendarioDiario();
      }
    }, 30000);

    // Manejar cambio de tama√±o de ventana
    window.addEventListener('resize', function() {
      if (esMovil()) {
        cargarCalendarioDiario();
      }
    });

    // Funci√≥n para generar citas de prueba
    async function generarCitasPrueba() {
      const mensajeDiv = document.getElementById('mensaje-desarrollo');
      mensajeDiv.innerHTML = '‚è≥ Generando citas de prueba...';
      
      try {
        const res = await fetch('/generar_citas_prueba', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        
        if (data.ok) {
          mensajeDiv.innerHTML = `‚úÖ ${data.mensaje}`;
          // Recargar el calendario para mostrar las nuevas citas
          setTimeout(() => {
            cargarCalendario();
            if (esMovil()) {
              cargarCalendarioDiario();
            }
          }, 1000);
        } else {
          mensajeDiv.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (error) {
        mensajeDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
      }
    }

    // Funci√≥n para limpiar todas las citas
    async function limpiarCitas() {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar todas las citas? Esta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      const mensajeDiv = document.getElementById('mensaje-desarrollo');
      mensajeDiv.innerHTML = '‚è≥ Limpiando citas...';
      
      try {
        const res = await fetch('/limpiar_citas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        
        if (data.ok) {
          mensajeDiv.innerHTML = `‚úÖ ${data.mensaje}`;
          // Recargar el calendario para mostrar los cambios
          setTimeout(() => {
            cargarCalendario();
            if (esMovil()) {
              cargarCalendarioDiario();
            }
          }, 1000);
        } else {
          mensajeDiv.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (error) {
        mensajeDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
      }
    }
  </script>
</body>
</html> 