<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Barber√≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            font-family: 'Georgia', 'Times New Roman', serif; 
            background: url('/static/fondo.png') no-repeat center center fixed;
            background-size: cover;
            margin: 0; 
            padding: 20px; 
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(40,40,50,0.30);
            z-index: 0;
            pointer-events: none;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: transparent;
            border-radius: 0; 
            box-shadow: none; 
            padding: 40px;
            border: none;
            position: relative;
            z-index: 1;
            backdrop-filter: none;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center; 
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: 'Georgia', serif;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #d4a574 0%, #b8860b 100%);
            color: #2c1810;
            border: 2px solid #8B4513;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            font-family: 'Georgia', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
            background: linear-gradient(135deg, #b8860b 0%, #8B4513 100%);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #90caf9 0%, #2196f3 100%);
            border-color: #1976d2;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%);
            border-color: #c62828;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            box-shadow: 0 8px 25px rgba(211, 47, 47, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #d4a574;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #fff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calendar-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .calendar-table th {
            background: rgba(139, 69, 19, 0.8);
            color: #fff;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calendar-table td {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: top;
            min-height: 80px;
        }

        .time-slot {
            padding: 8px;
            border-radius: 8px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            text-align: center;
        }

        .time-slot.available {
            background: rgba(76, 175, 80, 0.8);
            color: #fff;
        }

        .time-slot.available:hover {
            background: rgba(76, 175, 80, 1);
            transform: scale(1.05);
        }

        .time-slot.booked {
            background: rgba(244, 67, 54, 0.8);
            color: #fff;
            cursor: default;
        }

        .time-slot.closed {
            background: rgba(158, 158, 158, 0.8);
            color: #fff;
            cursor: not-allowed;
        }

        .time-slot.festivo {
            background: rgba(255, 193, 7, 0.8);
            color: #000;
            cursor: not-allowed;
        }

        .time-slot.domingo {
            background: rgba(156, 39, 176, 0.8);
            color: #fff;
            cursor: not-allowed;
        }

        .cita-info {
            margin-bottom: 5px;
        }

        .cita-nombre {
            font-weight: bold;
            display: block;
            margin-bottom: 2px;
        }

        .cita-telefono {
            font-size: 11px;
            display: block;
            margin-bottom: 2px;
        }

        .cita-servicio {
            font-size: 11px;
            display: block;
            margin-bottom: 2px;
        }

        .cita-peluquero {
            font-size: 11px;
            display: block;
            font-style: italic;
        }

        .opciones {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 5px;
        }

        .btn-opcion {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .filtro-peluquero {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filtro-peluquero select {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #8B4513;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #2c1810;
            cursor: pointer;
            margin-left: 10px;
        }

        .filtro-peluquero label {
            color: #fff;
            font-weight: bold;
            font-size: 16px;
        }

        .error {
            background: rgba(244, 67, 54, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            color: #fff;
            padding: 20px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #2c1810;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Estilos para el modal de agregar cita */
        #modal-agregar-cita .modal-content {
            max-width: 600px;
            text-align: left;
        }

        #modal-agregar-cita label {
            display: block;
            font-weight: bold;
            color: #2c1810;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #modal-agregar-cita input,
        #modal-agregar-cita select {
            width: 100%;
            padding: 12px;
            margin: 5px 0 15px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fff;
        }

        #modal-agregar-cita input:focus,
        #modal-agregar-cita select:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 8px rgba(139, 69, 19, 0.3);
            transform: translateY(-1px);
        }

        #modal-agregar-cita .form-group {
            margin-bottom: 20px;
        }

        #modal-agregar-cita .modal-buttons {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Estilos para el modal de editar cita */
        #modal-editar-cita .modal-content {
            max-width: 600px;
            text-align: left;
        }

        #modal-editar-cita label {
            display: block;
            font-weight: bold;
            color: #2c1810;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #modal-editar-cita input,
        #modal-editar-cita select {
            width: 100%;
            padding: 12px;
            margin: 5px 0 15px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fff;
        }

        #modal-editar-cita input:focus,
        #modal-editar-cita select:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 8px rgba(139, 69, 19, 0.3);
            transform: translateY(-1px);
        }

        #modal-editar-cita .form-group {
            margin-bottom: 20px;
        }

        #modal-editar-cita .modal-buttons {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Estilos para botones del modal de cita */
        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%) !important;
            border-color: #128c7e !important;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3) !important;
        }

        .btn-whatsapp:hover {
            background: linear-gradient(135deg, #128c7e 0%, #075e54 100%) !important;
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4) !important;
        }

        .btn-llamar {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            border-color: #0056b3 !important;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3) !important;
        }

        .btn-llamar:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4) !important;
        }

        /* Estilos para el modal de cita */
        #modal-cita .modal-content {
            max-width: 500px;
        }

        .cita-detalle {
            background: rgba(139, 69, 19, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #8B4513;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .cita-detalle:hover {
            background: rgba(139, 69, 19, 0.08);
            transform: translateX(5px);
        }

        .cita-detalle strong {
            color: #8B4513;
            display: inline-block;
            width: 100px;
            font-weight: 700;
            font-size: 14px;
        }

        .cita-detalle span {
            color: #2c1810;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-container {
                padding: 15px;
            }
            
            .calendar-table {
                font-size: 12px;
            }
            
            .calendar-table th,
            .calendar-table td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Panel de Administraci√≥n</h1>
            <div class="controls">
                <div>
                    <button class="btn" onclick="semanaAnterior()">‚óÄ Semana Anterior</button>
                    <button class="btn" onclick="irAHoy()">üìÖ Hoy</button>
                    <button class="btn" onclick="semanaSiguiente()">Semana Siguiente ‚ñ∂</button>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="window.location.href='/configuracion'">‚öôÔ∏è Configuraci√≥n</button>
                    <button class="btn" onclick="cargarCalendario()">üîÑ Actualizar</button>
                </div>
            </div>
        </div>

        <!-- Filtro por peluquero -->
        <div class="filtro-peluquero">
            <label for="filtro-peluquero">Filtrar por peluquero:</label>
            <select id="filtro-peluquero" onchange="cambiarPeluquero()">
                <option value="">Todos los peluqueros</option>
            </select>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-citas">0</div>
                <div class="stat-label">Total Citas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="citas-hoy">0</div>
                <div class="stat-label">Citas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="citas-semana">0</div>
                <div class="stat-label">Citas Esta Semana</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="citas-pendientes">0</div>
                <div class="stat-label">Citas Pendientes</div>
            </div>
        </div>

        <!-- Calendario -->
        <div class="calendar-container">
            <div id="calendario-semanal">
                <div class="loading">Cargando calendario...</div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div id="modal-eliminar" class="modal">
        <div class="modal-content">
            <h3>¬øEliminar cita?</h3>
            <p>Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="confirmarEliminar()">Eliminar</button>
                <button class="btn" onclick="cancelarEliminar()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de detalles de cita -->
    <div id="modal-cita" class="modal">
        <div class="modal-content">
            <h3>Detalles de la Cita</h3>
            <div id="cita-detalles">
                <!-- Los detalles se cargan din√°micamente -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="eliminarCitaDesdeModal()">üóëÔ∏è Eliminar</button>
                <button class="btn" onclick="editarCitaDesdeModal()">‚úèÔ∏è Editar</button>
                <button class="btn btn-whatsapp" onclick="enviarWhatsApp()">üì± WhatsApp</button>
                <button class="btn btn-llamar" onclick="llamarCliente()">üìû Llamar</button>
                <button class="btn" onclick="cerrarModalCita()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        let semanaActual = new Date();
        let peluqueroSeleccionado = null;
        let citaAEliminar = null;

        // Cargar peluqueros al iniciar
        cargarPeluqueros();

        // Funci√≥n para cargar peluqueros
        async function cargarPeluqueros() {
            try {
                const response = await fetch('/obtener_peluqueros');
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('filtro-peluquero');
                    
                    // Limpiar opciones existentes excepto la primera
                    select.innerHTML = '<option value="">Todos los peluqueros</option>';
                    
                    data.peluqueros.forEach(peluquero => {
                        const option = document.createElement('option');
                        option.value = peluquero.id;
                        option.textContent = peluquero.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('‚ùå Error cargando peluqueros:', error);
            }
        }

        // Funci√≥n para cambiar peluquero
        function cambiarPeluquero() {
            peluqueroSeleccionado = document.getElementById('filtro-peluquero').value;
            console.log(`üîÑ Cambiando a peluquero: ${peluqueroSeleccionado || 'Todos'}`);
            cargarCalendario();
        }

        // Funci√≥n para obtener el lunes de la semana
        function obtenerLunesSemana(fecha) {
            const lunes = new Date(fecha);
            const dia = lunes.getDay();
            const diff = lunes.getDate() - dia + (dia === 0 ? -6 : 1);
            lunes.setDate(diff);
            return lunes;
        }

        // Funci√≥n para generar d√≠as de la semana (hoy siempre a la izquierda)
        function generarDiasSemana(hoy) {
            const dias = [];
            for (let i = 0; i < 7; i++) {
                const dia = new Date(hoy);
                dia.setDate(hoy.getDate() + i);
                dias.push(dia);
            }
            return dias;
        }

        // Funci√≥n para verificar si un d√≠a est√° cerrado o es festivo
        async function verificarDiaEspecial(fecha) {
            try {
                const response = await fetch('/debug_dias_cerrados');
                if (response.ok) {
                    const data = await response.json();
                    const diasCerrados = data.dias_cerrados || [];
                    
                    // Verificar si es domingo
                    const dia = new Date(fecha);
                    if (dia.getDay() === 0) {
                        return { tipo: 'domingo', motivo: 'Domingo' };
                    }
                    
                    // Verificar si est√° cerrado
                    const diaCerrado = diasCerrados.find(d => d.fecha === fecha);
                    if (diaCerrado) {
                        return { tipo: 'cerrado', motivo: diaCerrado.motivo };
                    }
                    
                    // Verificar si es festivo
                    const responseFestivos = await fetch('/obtener_dias_festivos');
                    if (responseFestivos.ok) {
                        const dataFestivos = await responseFestivos.json();
                        const diasFestivos = dataFestivos.dias_festivos || [];
                        const diaFestivo = diasFestivos.find(d => d.fecha === fecha);
                        if (diaFestivo) {
                            return { tipo: 'festivo', motivo: diaFestivo.nombre };
                        }
                    }
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error verificando d√≠a especial:', error);
                return null;
            }
        }

        // Funci√≥n para cargar el calendario
        async function cargarCalendario() {
            try {
                // Usar semanaActual como punto de partida
                const dias = generarDiasSemana(semanaActual);
                
                // Cargar horarios disponibles desde la BD
                const response = await fetch('/obtener_horarios_disponibles');
                if (!response.ok) {
                    throw new Error('Error cargando horarios');
                }
                const data = await response.json();
                const horas = data.horarios || [];
                
                if (horas.length === 0) {
                    document.getElementById('calendario-semanal').innerHTML = 
                        '<div class="error">No hay horarios configurados. Ve a Configuraci√≥n para agregar horarios.</div>';
                    return;
                }
                
                let html = '<table class="calendar-table">';
                
                // Encabezados de d√≠as
                html += '<thead><tr><th>Hora</th>';
                dias.forEach(dia => {
                    html += `<th>${formatearFecha(dia)}</th>`;
                });
                html += '</tr></thead>';
                
                // Cuerpo de la tabla
                html += '<tbody>';
                
                horas.forEach(hora => {
                    html += '<tr>';
                    html += `<td style="font-weight: bold; background: rgba(255, 255, 255, 0.1);">${hora}</td>`;
                    
                    dias.forEach(dia => {
                        const fechaAPI = dia.toISOString().split('T')[0];
                        html += `<td id="celda-${fechaAPI}-${hora}" class="celda-cita">`;
                        html += `<div class="time-slot available" onclick="agregarCita('${fechaAPI}', '${hora}')">`;
                        html += `<span>Disponible</span>`;
                        html += '</div>';
                        html += '</td>';
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                document.getElementById('calendario-semanal').innerHTML = html;
                
                // Cargar citas para cada d√≠a
                await cargarCitasSemana(dias, horas);
                await cargarEstadisticas();
                
            } catch (error) {
                console.error('‚ùå Error cargando calendario:', error);
                document.getElementById('calendario-semanal').innerHTML = 
                    '<div class="error">Error cargando el calendario</div>';
            }
        }

        // Funci√≥n para cargar citas de la semana
        async function cargarCitasSemana(dias, horas) {
            for (const dia of dias) {
                const fechaAPI = dia.toISOString().split('T')[0];
                await cargarCitasDia(fechaAPI, horas);
            }
        }

        // Funci√≥n para cargar citas de un d√≠a espec√≠fico
        async function cargarCitasDia(fechaAPI, horas) {
            try {
                console.log(`üìÖ Cargando citas para: ${fechaAPI} (Peluquero: ${peluqueroSeleccionado || 'Todos'})`);
                
                // Primero obtener las citas del d√≠a
                const response = await fetch('/citas_dia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        dia: fechaAPI,
                        peluquero_id: peluqueroSeleccionado || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`üìä Citas recibidas para ${fechaAPI} (Peluquero: ${peluqueroSeleccionado || 'Todos'}):`, data);
                
                const citas = data.citas || [];
                
                // Verificar si el d√≠a es especial (cerrado, festivo, domingo)
                const diaEspecial = await verificarDiaEspecial(fechaAPI);
                
                // Si hay citas existentes, NO mostrar como d√≠a especial
                // (las citas tienen prioridad sobre el estado del d√≠a)
                const tieneCitas = citas.length > 0;
                
                // Limpiar celdas del d√≠a
                horas.forEach(hora => {
                    const celda = document.getElementById(`celda-${fechaAPI}-${hora}`);
                    if (celda) {
                        // Buscar si hay una cita en esta hora
                        const citaEnHora = citas.find(c => c.hora === hora);
                        
                                                if (citaEnHora) {
                            // Mostrar la cita existente
                                                celda.innerHTML = `
                            <div class="time-slot booked" onclick="mostrarModalCita(${citaEnHora.id}, '${citaEnHora.nombre || citaEnHora.cliente}', '${citaEnHora.telefono}', '${citaEnHora.servicio}', '${citaEnHora.peluquero_nombre || 'Sin asignar'}', '${fechaAPI}', '${citaEnHora.hora}')">
                                <div class="cita-info">
                                    <span class="cita-nombre">${citaEnHora.nombre || citaEnHora.cliente}</span>
                                    <span class="cita-servicio">${citaEnHora.servicio}</span>
                                    <span class="cita-peluquero">üë®‚Äçüíº ${citaEnHora.peluquero_nombre || 'Sin asignar'}</span>
                                </div>
                            </div>
                        `;
                        } else if (diaEspecial && !tieneCitas) {
                            // D√≠a especial sin citas: mostrar como cerrado/festivo/domingo
                            let clase = 'closed';
                            let texto = 'Cerrado';
                            
                            if (diaEspecial.tipo === 'festivo') {
                                clase = 'festivo';
                                texto = diaEspecial.motivo;
                            } else if (diaEspecial.tipo === 'domingo') {
                                clase = 'domingo';
                                texto = 'Domingo';
                            }
                            
                            celda.innerHTML = `<div class="time-slot ${clase}">
                                <span>${texto}</span>
                            </div>`;
                        } else {
                            // D√≠a normal o d√≠a especial con citas: mostrar como disponible
                            celda.innerHTML = `<div class="time-slot available" onclick="agregarCita('${fechaAPI}', '${hora}')">
                                <span>Disponible</span>
                            </div>`;
                        }
                    }
                });
                
            } catch (error) {
                console.error(`‚ùå Error cargando citas del d√≠a ${fechaAPI}:`, error);
            }
        }

        // Funci√≥n para cargar estad√≠sticas
        async function cargarEstadisticas() {
            try {
                const response = await fetch('/estadisticas');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('total-citas').textContent = stats.total_citas || 0;
                    document.getElementById('citas-hoy').textContent = stats.citas_hoy || 0;
                    document.getElementById('citas-semana').textContent = stats.citas_semana || 0;
                    document.getElementById('citas-pendientes').textContent = stats.citas_pendientes || 0;
                }
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
            }
        }

        // Funci√≥n para agregar cita
        async function agregarCita(fecha, hora) {
            // Verificar si el d√≠a est√° cerrado antes de permitir agregar cita
            const diaEspecial = await verificarDiaEspecial(fecha);
            if (diaEspecial) {
                let mensaje = 'No se pueden agregar citas en d√≠as cerrados.';
                if (diaEspecial.tipo === 'festivo') {
                    mensaje = `No se pueden agregar citas en d√≠as festivos (${diaEspecial.motivo}).`;
                } else if (diaEspecial.tipo === 'domingo') {
                    mensaje = 'No se pueden agregar citas en domingos.';
                }
                alert(mensaje);
                return;
            }
            
            // Mostrar modal para agregar cita
            mostrarModalAgregarCita(fecha, hora);
        }

        // Funci√≥n para mostrar modal de agregar cita
        async function mostrarModalAgregarCita(fecha, hora) {
            // Cargar servicios y peluqueros
            const [servicios, peluqueros] = await Promise.all([
                fetch('/obtener_servicios').then(r => r.json()),
                fetch('/obtener_peluqueros').then(r => r.json())
            ]);
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'modal-agregar-cita';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Agregar Cita</h3>
                    <p style="margin-bottom: 25px; color: #666; font-size: 14px;">
                        <strong>Fecha:</strong> ${formatearFecha(new Date(fecha))} - <strong>Hora:</strong> ${hora}
                    </p>
                    
                    <div class="form-group">
                        <label for="nombre-cliente">Nombre del cliente:</label>
                        <input type="text" id="nombre-cliente" placeholder="Nombre completo">
                    </div>
                    
                    <div class="form-group">
                        <label for="telefono-cliente">Tel√©fono:</label>
                        <input type="tel" id="telefono-cliente" placeholder="Tel√©fono">
                    </div>
                    
                    <div class="form-group">
                        <label for="servicio-cita">Servicio:</label>
                        <select id="servicio-cita">
                            <option value="">Seleccionar servicio...</option>
                            ${servicios.servicios ? servicios.servicios.map(s => `<option value="${s.nombre}">${s.nombre} - ${s.precio}</option>`).join('') : ''}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="peluquero-cita">Peluquero:</label>
                        <select id="peluquero-cita">
                            <option value="">Sin asignar</option>
                            ${peluqueros.peluqueros ? peluqueros.peluqueros.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('') : ''}
                        </select>
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="btn" onclick="confirmarAgregarCita('${fecha}', '${hora}')">Agregar Cita</button>
                        <button class="btn" onclick="cancelarAgregarCita()">Cancelar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Funci√≥n para confirmar agregar cita
        function confirmarAgregarCita(fecha, hora) {
            const nombre = document.getElementById('nombre-cliente').value.trim();
            const telefono = document.getElementById('telefono-cliente').value.trim();
            const servicio = document.getElementById('servicio-cita').value;
            const peluqueroId = document.getElementById('peluquero-cita').value || null;
            
            if (!nombre || !telefono || !servicio) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            fetch('/agregar_cita', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fecha: fecha,
                    hora: hora,
                    nombre: nombre,
                    telefono: telefono,
                    servicio: servicio,
                    peluquero_id: peluqueroId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarCalendario();
                    cancelarAgregarCita();
                } else {
                    alert('Error al agregar la cita: ' + (data.msg || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar la cita');
            });
        }

        // Funci√≥n para cancelar agregar cita
        function cancelarAgregarCita() {
            const modal = document.getElementById('modal-agregar-cita');
            if (modal) {
                modal.remove();
            }
        }

        // Funci√≥n para eliminar cita
        function eliminarCita(id) {
            citaAEliminar = id;
            document.getElementById('modal-eliminar').style.display = 'block';
        }

        // Funci√≥n para confirmar eliminaci√≥n
        function confirmarEliminar() {
            if (citaAEliminar) {
                fetch('/borrar_cita', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: citaAEliminar })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                    cargarCalendario();
                } else {
                    alert('Error al eliminar la cita');
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar la cita');
                });
            }
            cancelarEliminar();
        }

        // Funci√≥n para cancelar eliminaci√≥n
        function cancelarEliminar() {
            document.getElementById('modal-eliminar').style.display = 'none';
            citaAEliminar = null;
        }

        // Variables globales para el modal de cita
        let citaActual = null;

        // Funci√≥n para mostrar modal de cita
        function mostrarModalCita(id, nombre, telefono, servicio, peluquero, fecha, hora) {
            citaActual = { id, nombre, telefono, servicio, peluquero, fecha, hora };
            
            const modal = document.getElementById('modal-cita');
            const detalles = document.getElementById('cita-detalles');
            
            detalles.innerHTML = `
                <div class="cita-detalle">
                    <strong>Cliente:</strong> <span>${nombre}</span>
                </div>
                <div class="cita-detalle">
                    <strong>Tel√©fono:</strong> <span>${telefono}</span>
                </div>
                <div class="cita-detalle">
                    <strong>Servicio:</strong> <span>${servicio}</span>
                </div>
                <div class="cita-detalle">
                    <strong>Peluquero:</strong> <span>${peluquero}</span>
                </div>
                <div class="cita-detalle">
                    <strong>Fecha:</strong> <span>${formatearFecha(new Date(fecha))}</span>
                </div>
                <div class="cita-detalle">
                    <strong>Hora:</strong> <span>${hora}</span>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Funci√≥n para cerrar modal de cita
        function cerrarModalCita() {
            const modal = document.getElementById('modal-cita');
            modal.style.display = 'none';
            citaActual = null;
        }

        // Funci√≥n para eliminar cita desde modal
        function eliminarCitaDesdeModal() {
            if (citaActual) {
                citaAEliminar = citaActual.id;
                cerrarModalCita();
                document.getElementById('modal-eliminar').style.display = 'block';
            }
        }

        // Funci√≥n para editar cita desde modal
        function editarCitaDesdeModal() {
            if (citaActual) {
                mostrarModalEditarCita();
            }
        }

        // Funci√≥n para mostrar modal de editar cita
        async function mostrarModalEditarCita() {
            // Cargar servicios y peluqueros
            const [servicios, peluqueros] = await Promise.all([
                fetch('/obtener_servicios').then(r => r.json()),
                fetch('/obtener_peluqueros').then(r => r.json())
            ]);
            
            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'modal-editar-cita';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Editar Cita</h3>
                    <p style="margin-bottom: 25px; color: #666; font-size: 14px;">
                        <strong>Fecha:</strong> ${formatearFecha(new Date(citaActual.fecha))} - <strong>Hora:</strong> ${citaActual.hora}
                    </p>
                    
                    <div class="form-group">
                        <label for="edit-nombre-cliente">Nombre del cliente:</label>
                        <input type="text" id="edit-nombre-cliente" value="${citaActual.nombre}" placeholder="Nombre completo">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-telefono-cliente">Tel√©fono:</label>
                        <input type="tel" id="edit-telefono-cliente" value="${citaActual.telefono}" placeholder="Tel√©fono">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-servicio-cita">Servicio:</label>
                        <select id="edit-servicio-cita">
                            <option value="">Seleccionar servicio...</option>
                            ${servicios.servicios ? servicios.servicios.map(s => `<option value="${s.nombre}" ${s.nombre === citaActual.servicio ? 'selected' : ''}>${s.nombre} - ${s.precio}</option>`).join('') : ''}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-peluquero-cita">Peluquero:</label>
                        <select id="edit-peluquero-cita">
                            <option value="">Sin asignar</option>
                            ${peluqueros.peluqueros ? peluqueros.peluqueros.map(p => `<option value="${p.id}" ${p.nombre === citaActual.peluquero ? 'selected' : ''}>${p.nombre}</option>`).join('') : ''}
                        </select>
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="btn" onclick="confirmarEditarCita()">Guardar Cambios</button>
                        <button class="btn" onclick="cancelarEditarCita()">Cancelar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            cerrarModalCita();
        }

        // Funci√≥n para confirmar editar cita
        function confirmarEditarCita() {
            const nombre = document.getElementById('edit-nombre-cliente').value.trim();
            const telefono = document.getElementById('edit-telefono-cliente').value.trim();
            const servicio = document.getElementById('edit-servicio-cita').value;
            const peluqueroId = document.getElementById('edit-peluquero-cita').value || null;
            
            if (!nombre || !telefono || !servicio) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            
            fetch('/editar_cita', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: citaActual.id,
                    nombre: nombre,
                    telefono: telefono,
                    servicio: servicio,
                    peluquero_id: peluqueroId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarCalendario();
                    cancelarEditarCita();
                } else {
                    alert('Error al editar la cita: ' + (data.msg || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al editar la cita');
            });
        }

        // Funci√≥n para cancelar editar cita
        function cancelarEditarCita() {
            const modal = document.getElementById('modal-editar-cita');
            if (modal) {
                modal.remove();
            }
        }

        // Funci√≥n para enviar WhatsApp
        function enviarWhatsApp() {
            if (citaActual) {
                const telefono = citaActual.telefono.replace(/\s/g, '');
                const mensaje = `Hola ${citaActual.nombre}, te recordamos tu cita para ${citaActual.servicio} el ${formatearFecha(new Date(citaActual.fecha))} a las ${citaActual.hora}. ¬øConfirmas asistencia?`;
                const url = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
                window.open(url, '_blank');
            }
        }

        // Funci√≥n para llamar al cliente
        function llamarCliente() {
            if (citaActual) {
                const telefono = citaActual.telefono.replace(/\s/g, '');
                window.open(`tel:${telefono}`, '_blank');
            }
        }

        // Funci√≥n para editar cita (mantener para compatibilidad)
        function editarCita(id) {
            // Implementar edici√≥n de cita
            alert('Funci√≥n de edici√≥n en desarrollo');
        }

        // Funci√≥n para formatear fecha
        function formatearFecha(fecha) {
            const opciones = { 
                weekday: 'short', 
                day: 'numeric', 
                month: 'short' 
            };
            return fecha.toLocaleDateString('es-ES', opciones);
        }

                // Funci√≥n para semana anterior
        function semanaAnterior() {
            semanaActual.setDate(semanaActual.getDate() - 7);
            cargarCalendario();
        }

        // Funci√≥n para semana siguiente
        function semanaSiguiente() {
            semanaActual.setDate(semanaActual.getDate() + 7);
                    cargarCalendario();
        }

        // Funci√≥n para ir a hoy
        function irAHoy() {
            semanaActual = new Date();
            cargarCalendario();
        }

        // Cargar calendario al iniciar
            cargarCalendario();
            
            // Actualizar cada 30 segundos
            setInterval(cargarCalendario, 30000);
    </script>
</body>
</html> 